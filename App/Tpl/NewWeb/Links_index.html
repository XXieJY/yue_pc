<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /> 
  <title>推广链接</title> 
  <meta name="description" content="" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" /> 
 </head>
 <body class="no-skin">
  <include file="Head:include" />  
  <!-- #section:basics/navbar.layout --> 
  <div id="navbar" class="navbar navbar-default"> 
   <include file="Navbar:include" />
  </div> 
  <div class="main-container" id="main-container"> 
   <script type="text/javascript">try {
          ace.settings.check('main-container', 'fixed')
        } catch(e) {}</script> 
   <include file="Sidebar:include" /> 
   <div class="main-content"> 
    <{$weixin_tps}>
      <include file="Bread:include" /> 
    <div class="page-content"> 
     <div class="page-content-area"> 
      <div class="row"> 
       <div class="col-xs-12"> 
        <!-- PAGE CONTENT BEGINS --> 
        <!--/span--> 
        <!-- left menu ends --> 
        <div class="actions-bar"> 
         <form class="form-inline search-form"> 
          <div class="pull-left"> 
           <div class="input-group"> 
            <input type="text" name="q" value="" placeholder="渠道名称" /> 
            <span class="input-group-btn"> <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button> </span> 
           </div> 
          </div> 
         </form> 
        </div> 
        <table class="table table-striped table-bordered table-hover responsive"> 
         <thead> 
          <tr> 
           <td> 推广链接 </td> 
           <td> 入口页面 </td> 
           <td class="text-right"> 原文点击次数 </td> 
           <td class="text-right"> 充值金额 </td> 
           <td class="text-center"> 操作 </td> 
          </tr> 
         </thead> 
         <tbody> 
          <volist name="data" id="vo" empty="$empty">
          <tr class="referral-link-item" data-link-id="<{$vo.channel_id}>">          
           <td> 
            <div style="margin-bottom:5px;"> 
             <span class="link-desc"><{$vo.name}></span> 
            </div> <span class="text-primary" id="link-<{$vo.channel_id}>"><{$vo.link}></span> <i class="fa fa-copy" title="点击复制" style="cursor:pointer" data-toggle="copy-link" data-clipboard-target="#link-<{$vo.channel_id}>"></i> 
            <div class="text-muted" style="font-size:13px;margin-top:5px">
              创建时间: <{$vo.time}> 
            </div> </td> 
           <td> 
            <div style="line-height:1.7em"> 
             <a href="/NewWeb/Novels/view/id/<{$vo.book_id}>"><{$vo.book_name}></a> 
             <br /> 第<{$vo.num_id}>章 
            </div> 
<!--             <div class="text-muted">
              关注章节: 默认 (10)
            </div>  --></td> 
           <td class="text-right"> <span class="counter-field" data-field="clicks"><{$vo.click_total}></span> </td> 
           <td class="text-right"> <{$vo.pay_total}></td> 
           <td class="text-center"> <a href="/NewWeb/Orders?channel_id=<{$vo.channel_id}>" class="btn btn-xs btn-success"><i class="fa fa-list"></i> 订单明细</a> 
<!--             <div class="btn-group"> 
             <button type="button" class="btn btn-xs btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false"> 更多 <span class="caret"></span> </button> 
             <ul class="dropdown-menu dropdown-menu-right"> 
              <li> <a href="#" data-toggle="edit-referral-link" data-id="705936"><i class="fa fa-edit"></i> 修改</a> </li> 
              <li> <a target="_blank" href="/NewWeb/wx_article_editor?referral_link_id=705936"><i class="fa fa-image"></i> 文案</a> </li> 
              <li class="divider"></li> 
              <li> <a href="#" data-toggle="delete-referral-link" data-id="705936"><i class="fa fa-trash-o"></i> 删除</a> </li> 
             </ul> 
            </div>  -->
            <a class="btn btn-xs btn-danger" onclick="return confirm('确定删除推广链接吗？')" href="/NewWeb/Links/del/id/<{$vo.channel_id}>">删除</a>
            </td> 
            </tr> 
            </volist>
         </tbody> 
        </table> 
        <{$page}>
        <div class="modal fade" id="create-referral-link-modal" tabindex="-1"> 
         <div class="modal-dialog" role="document"> 
          <div class="modal-content"> 
           <div class="modal-header"> 
            <button type="button" class="close" data-bind="click: close" aria-label="Close"><span aria-hidden="true">&times;</span></button> 
            <h4 class="modal-title" data-bind="text: title"></h4> 
           </div> 
           <div class="modal-body"> 
            <div data-bind="visible: loading" class="loading-panel"> 
             <i class="fa fa-spin fa-spinner"></i> 
            </div> 
            <form class="form-horizontal" style="display: none" data-bind="visible: !loading()" novalidate="novalidate"> 
             <div class="form-group"> 
              <label class="control-label col-sm-3"><span class="required" aria-required="true">*</span> 派单渠道名称</label> 
              <div class="col-sm-7"> 
               <input type="text" class="form-control" maxlength="100" name="description" data-val="true" data-val-required="请填写派单渠道名称" data-bind="value: description" /> 
               <p class="help-block help-block-error" data-valmsg-for="description" data-valmsg-replace="true"></p> 
              </div> 
             </div> 
             <div class="form-group"> 
              <label class="control-label col-sm-3"><span class="required" aria-required="true">*</span> 是否强制关注</label> 
              <div class="col-sm-7"> 
               <label class="radio-inline"> <input type="radio" name="referrer_type" value="verified_mp" data-bind="checked: referrer_type" data-val="true" data-val-required="请选择是否强制关注" /> <span>是</span> </label> 
               <label class="radio-inline"> <input type="radio" name="referrer_type" value="not_verified_mp" data-bind="checked: referrer_type" /> <span>否</span> </label> 
               <p class="help-block help-block-error" data-valmsg-for="referrer_type" data-valmsg-replace="true"></p> 
              </div> 
             </div> 
            </form> 
           </div> 
           <div class="modal-footer"> 
            <button type="button" class="btn btn-primary" data-bind="click: submit, text: id() ? '保存修改' : '生成链接'"></button> 
           </div> 
          </div> 
         </div> 
        </div> 
        <script>
    var GetReferralLinkModal = function () {
        var self = this;
        var $modal = null;
        var callbacks = null;
        var defer = null;
        var opts = null;
        var link = null; // 生成的链接，{ id, url }
        var model = {
            loading: ko.observable(false),
            submitting: ko.observable(false),

            title: ko.observable(),

            id: ko.observable(),
            type: ko.observable(0),
            article_id: ko.observable(),
            novel_id: ko.observable(),
            novel_avatar: ko.observable(),
            novel_title: ko.observable(),
            article_title: ko.observable(),
            referrer_type: ko.observable(),
            description: ko.observable(),
            force_follow_chapter_idx: ko.observable(),
            force_follow_chapter_id: ko.observable(),
            force_follow_chapter_title: ko.observable(),

            submit: function () {
                self.submit();
            },
            close: function () {
                self.close();
            }
        };

        self.open = function (options) {
            self.reset();

            defer = $.Deferred();

            opts = options;

            if (!$modal) {
                $modal = $('#create-referral-link-modal');
                ko.applyBindings(model, $modal.find('.modal-content')[0]);

                model.force_follow_chapter_idx.subscribe(function (idx) {
                   if (!idx || !/^\d+$/.test(idx)) {
                       model.force_follow_chapter_id(null);
                       model.force_follow_chapter_title(null);
                   } else {
                       self.tryFetchForceFollowChapterInfo();
                   }
                });
            }

            callbacks = options.callbacks || {};

            model.title(options.title || (options.id ? '修改推广链接属性' : '生成推广链接'));

            if (options.type !== undefined) {
                model.type(options.type);
            }

            model.loading(true);

            var promise = $.Deferred().resolve().promise();

            if (options.id) {
                model.id(options.id);

                promise = $.get('/backend/referral_links/api_get/' + options.id, function (result) {
                    model.type(result.type);
                    model.article_id(result.article_id);
                    model.description(result.description);
                    model.referrer_type(result.referrer_type);
                    model.force_follow_chapter_idx(result.force_follow_chapter_idx);

                    opts.wx_article_title_id = result.wx_article_title_id;
                    opts.wx_article_cover_id = result.wx_article_cover_id;
                    opts.wx_article_body_template_id = result.wx_article_body_template_id;
                    opts.wx_article_footer_template_id = result.wx_article_footer_template_id;
                });
            } else {
                model.article_id(options.article_id);
            }

            promise.then(function () {
                self.tryFetchNovelArticleInfo();
                self.tryFetchForceFollowChapterInfo();
                model.loading(false);
            });

            $modal.modal('show');

            return defer.promise();
        };

        self.tryFetchNovelArticleInfo = function () {
            var articleId = model.article_id();
            if (!articleId) {
                return $.Deferred().resolve();
            }

            return $.get('/backend/novels/api_get_short_article_info/' + articleId)
                .then(function (result) {
                    model.novel_id(result.novel.id);
                    model.novel_avatar(result.novel.avatar);
                    model.novel_title(result.novel.title);
                    model.article_title(result.title);
                });
        };

        self.tryFetchForceFollowChapterInfo = function () {
            var idx = model.force_follow_chapter_idx();
            if (idx) {
                idx = parseInt(idx);
            }

            if (!idx) {
                return false;
            }

            // 如果 novel_id 未加载，也忽略，novel_id 加载后会再触发一次获取关注章节信息
            if (!model.novel_id()) {
                return false;
            }

            $.get('/backend/articles/api_get_basic_info_by_idx', {
                nid: model.novel_id(),
                idx: model.force_follow_chapter_idx()
            })
                .then(function (result) {
                    model.force_follow_chapter_id(result.id);
                    model.force_follow_chapter_title(result.title);
                })
                .fail(handleAjaxError);
        };

        self.submit = function () {
            if (model.submitting()) {
                return false;
            }

            if (!$modal.find('form').valid()) {
                return false;
            }

            model.submitting(true);

            $.ajax({
                url: '/backend/referral_links/api_save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: model.id(),
                    type: model.type(),
                    article_id: model.article_id(),
                    referrer_type: model.referrer_type(),
                    force_follow_chapter_idx: model.force_follow_chapter_idx(),
                    description: model.description(),
                    wx_article_title_id: opts.wx_article_title_id,
                    wx_article_cover_id: opts.wx_article_cover_id,
                    wx_article_body_template_id: opts.wx_article_body_template_id,
                    wx_article_footer_template_id: opts.wx_article_footer_template_id
                })
            })
                .then(function (result) {
                    link = result;

                    if (callbacks.link_generated) {
                        callbacks.link_generated(result);
                    }

                    self.close();

                    Modal.open({
                        title: model.id() ? '保存成功' : '推广链接生成成功',
                        backdrop: 'static',
                        keyboard: false,
                        body:
                            '<div>' +
                                '<div>请复制下方推广链接，后续您可以在后台菜单的"推广链接"中找到它并查看统计数据:</div>' +
                                '<div style="margin:10px 0" class="text-primary">' + result.url + '</div>' +
                                '<div style="margin:10px 0;color:red;font-weight:bold;"><i class="fa fa-info-circle"></i> 请务必使用此链接作为文案的原文链接，不要使用微信中点开后手工复制的链接</div>' +
                            '</div>',
                        callbacks: {
                            close: function () {
                                if (link) {
                                    defer.resolve(link);
                                } else {
                                    defer.reject({ reason: 'cancel' });
                                }
                            }
                        },
                        buttons: [
                            {
                                text: '复制链接',
                                className: 'btn-primary',
                                clipboard: {
                                    text: function () {
                                        return link.url;
                                    },
                                    success: function () {
                                        var $modal = this.$modal();
                                        var $hint = $modal.find('.copy-success-hint');
                                        if ($hint.length === 0) {
                                            $modal.find('.modal-footer').prepend('<span style="display:inline-block;margin-right:10px;color:red;vertical-align:middle;" class="copy-success-hint"></span>');
                                            $hint = $modal.find('.copy-success-hint');
                                        }

                                        $hint.html('复制成功!');
                                    }
                                }
                            },
                            {
                                text: '关闭',
                                click: function () {
                                    this.close();
                                }
                            }
                        ]
                    })
                })
                .fail(handleAjaxError)
                .always(function () {
                    model.submitting(false);
                });
        };

        self.close = function () {
            $modal.modal('hide');
        };

        self.reset = function () {
            link = null;

            model.loading(false);
            model.submitting(false);

            model.id(null);
            model.article_id(null);
            model.novel_avatar(null);
            model.novel_title(null);
            model.article_title(null);
            model.referrer_type(null);
            model.force_follow_chapter_idx(null);
            model.force_follow_chapter_id(null);
            model.force_follow_chapter_title(null);
            model.description(null);
        }
    };

    GetReferralLinkModal.instance = new GetReferralLinkModal();

    $(function () {
        $(document).on('click', '[data-toggle="create-referral-link"]', function () {
            GetReferralLinkModal.instance.open({
                article_id: $(this).data('article-id')
            });

            return false;
        });
    });
</script> 
        <div class="modal fade" id="export-referral-links-modal" tabindex="-1"> 
         <div class="modal-dialog" role="document"> 
          <div class="modal-content"> 
           <div class="modal-header"> 
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> 
            <h4 class="modal-title">选择链接创建时间</h4> 
           </div> 
           <div class="modal-body"> 
            <div class="form-inline"> 
             <div class="form-group"> 
              <div class="input-group date from-date-picker"> 
               <input type="text" class="form-control" placeholder="开始日期" /> 
               <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span> 
              </div> 
             </div> 
             <div class="form-group"> 
              <div class="input-group date to-date-picker"> 
               <input type="text" class="form-control" placeholder="结束日期" /> 
               <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span> 
              </div> 
             </div> 
            </div> 
           </div> 
           <div class="modal-footer"> 
            <button type="button" class="btn btn-primary btn-export">确认导出</button> 
           </div> 
          </div> 
         </div> 
        </div> 
        <script>
    var ExportReferralLinksModal = function () {
        var self = this;
        var $modal = null;
        var inited = false;

        this.open = function () {
            if (!$modal) {
                $modal = $('#export-referral-links-modal');
                $modal.on('shown.bs.modal', function () {
                    init();
                });
            }

            $modal.modal('show');
        };

        this.dateRange = function () {
           return {
               from: $modal.find('.from-date-picker :text').val(),
               to: $modal.find('.to-date-picker :text').val()
           };
        };

        function doExport() {
            var range = self.dateRange();
            if (!range.from || !range.to) {
                alert('请选择日期范围');
                return false;
            }

            var days = moment(range.to).diff(range.from, 'days') + 1;
            if (days > 7) {
                alert('日期区间不能大于7天');
                return false;
            }

            var qs = _.extend({}, parseQueryString(), {
                alt: 'excel',
                from: range.from,
                to: range.to
            });

            location.href = location.pathname + buildQueryString(qs);
        }

        function init() {
            if (inited) {
                return false;
            }

            $modal.find('.from-date-picker').datetimepicker({ format: 'YYYY-MM-DD', defaultDate: moment().add(-6, 'days') });
            $modal.find('.to-date-picker').datetimepicker({ format: 'YYYY-MM-DD', defaultDate: moment() });

            $modal.find('.btn-export').click(function () {
                doExport();
                return false;
            });

            inited = true;
        }
    };

    ExportReferralLinksModal.instance = new ExportReferralLinksModal();
</script> 
        <script>
    $(function () {

        $('[data-toggle="tooltip"]').tooltip();

        // $('.referral-link-item').each(function () {
        //    loadCounter($(this).data('link-id'));
        // });

        $('#btn-export-links').click(function () {
            ExportReferralLinksModal.instance.open();
            return false;
        });

        function loadCounter(id) {
            return $.get('/backend/referral_links/api_get_counter/' + id, function (counter) {
                var $row = $('.referral-link-item[data-link-id="' + id + '"]');
                $row.find('.counter-field').each(function () {
                    var field = $(this).data('field');

                    if (field === 'subscribe_rate') {
                        $(this).html(Math.round(counter[field] * 100));
                    } else {
                        $(this).html(counter[field]);
                    }
                });

                if (counter.subscribe_rate > 0) {
                    $row.find('.subscribe-rate-container').show();
                }
            });
        }

        $('[data-toggle="copy-link"]').each(function () {
           new Clipboard(this).on('success', function (e) {
               e.clearSelection();
               toastr.success('复制成功');
           });
        });

        $('[data-toggle="create-referral-link"]').click(function () {
            var type = $(this).data('type');
            if (type == '0') {
                Modal.alert({
                    title: '创建小说推广',
                    message: '请在小说章节列表中选择"创建推广链接"或"生成推广文案"'
                });
            } else {
                GetReferralLinkModal.instance.open({
                    type: type
                })
                    .then(function () {
                        reloadPage(500);
                    });
            }

            return false;
        });

        $('[data-toggle="edit-referral-link"]').click(function () {
            var id = $(this).data('id');
            GetReferralLinkModal.instance
                .open({
                    id: id
                })
                .then(function () {
                    reloadPage(500);
                });

            return false;
        });

        $('[data-toggle="delete-referral-link"]').click(function () {
            var id = $(this).data('id');
            var desc = $(this).closest('tr').find('.link-desc').text().trim();

            Modal.confirm({
                title: '删除确认',
                message: '确定要删除推广链接 "' + desc + '" 吗?'
            })
            .then(function () {
                $.ajax({
                    url: '/backend/referral_links/api_delete/' + id,
                    type: 'POST',
                    contentType: 'application/json'
                })
                .then(function () {
                    toastr.success('删除成功');
                    reloadPage(500);
                })
                .fail(handleAjaxError);
            });

            return false;
        });

        $('[data-toggle="block-link"]').click(function () {
            var id = $(this).data('id');
            $.ajax({
              url: '/backend/referral_links/api_block/' + id,
              type: 'POST',
              contentType: 'application/json'
            })
              .then(function () {
                toastr.success('屏蔽成功');
                reloadPage(500);
              })
              .fail(handleAjaxError);

            return false;
        });

        $('[data-toggle="unblock-link"]').click(function () {
            var id = $(this).data('id');
            $.ajax({
              url: '/backend/referral_links/api_unblock/' + id,
              type: 'POST',
              contentType: 'application/json'
            })
              .then(function () {
                toastr.success('解除屏蔽成功');
                reloadPage(500);
              })
              .fail(handleAjaxError);

            return false;
        });
    });
</script> 
        <!-- PAGE CONTENT ENDS --> 
       </div>
       <!-- /.col --> 
      </div>
      <!-- /.row --> 
     </div>
     <!-- /.page-content-area --> 
    </div>
    <!-- /.page-content --> 
   </div> 
   <!-- /.main-content -->
  </div> 
  <!-- /.main-container --> 
  <!-- basic scripts --> 
  <include file="Script:include" /> 
 </body>
</html>